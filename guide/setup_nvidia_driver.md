# Настройка и установка драйвера NVIDIA


## 1 Способ: Ручная очистка и установка драйвера

- Загрузите последнюю версию *Game ready* драйвера с помощью страницы [расширенный поиск драйверов](https://www.nvidia.com/download/find.aspx).

- Распакуйте исполняемый пакет драйвера с помощью программы 7-Zip и удалите все файлы и папки, кроме следующих:

    ```
    Display.Driver
    NVI2
    EULA.txt
    ListDevices.txt
    setup.cfg
    setup.exe
    ```

- Удалите следующие строки из файла ``setup.cfg`` (ближе к концу файла):

    ```
    <file name="${{EulaHtmlFile}}"/>
    <file name="${{FunctionalConsentFile}}"/>
    <file name="${{PrivacyPolicyFile}}"/>
    ```

- Запустите ``setup.exe`` для установки драйвера

> [!CAUTION]
> Ручной способ не подходит для ноутбуков, так как удаляется компонент Optimus.
>
## 2 Способ: Установка при помощи NVCleanstall

- Скачайте NVCleanstall с [TechPowerUp](https://www.techpowerup.com/download/techpowerup-nvcleanstall/)

- Запустите и выберите необходимый драйвер (обычно программа сама выбирает самый подходящий)

- Выберите необходимые для вас компоненты (их зависимости видны в правой части)

    - Если вы хотите установить только драйвер, то пропустите этот пункт

    - Если у вас ноутбук, то обязательно включите [Optimus](https://www.nvidia.com/en-us/geforce/technologies/optimus/technology/)      

-  В настройке драйвера выберите следующие пункты:

    ```
    Disable Installer Telemety & Advertising
    Unattended Express Installation
    Disable Ansel
    ```

    - С версии 1.17.0 Добавленны инструкции для новых драйверов с NvApp.

    - Отключение `HDCP` ничего не делает.

    - Остальные пункты можете выставить самостоятельно, при необходимости.

    - Отключать MPO бесполезно. 

## Настройка драйвера

- Я не рекомендую лазить в панели и трогать разделы, кроме:

    - Управление параметрами 3D

        > Потому что остальные разделы не нужны или вредны (например ломающая скейлинг настройка машстабирования), когда есть аналоги, которые работают лучше 

- В `Управление параметрами 3D` выставьте следующие параметры:
  
    - Режим управления питанием - Максимальная производительность

        - Для ноутбуков поставьте `Оптимально`

    - Размер кэша шейдеров - неограниченно

    - Фильтрация текстур (Качество) - Высокая производительность

    - Потоковая оптимизация - перегружает задачи обработки, связанные с GPU, на CPU ([1](https://tweakguides.pcgamingwiki.com/NVFORCE_8.html)). Это может навредить частоте кадров, так как отнимает процессорное время у приложения, работающего в реальном времени, но тем не менее бенчмарк следует провести. 

        - Если вы решите включить эту настройку, вам также следует определить, не испытываете ли вы нагрузку на процессор.
        
        - Эта настройка работает только для приложений на движке OpenGL.
    
    - Убедитесь, что настройки не переопределяются для программ на вкладке ``Настройки программы``, например, резкость изображения для некоторых игр EAC, чтобы избежать неожиданных результатов.
    
    - Режим низкой задержки (LLM) - Выкл 
    
        - Если вы оставите включенными LLM, и включите NVIDIA Reflex, Reflex будет иметь более высокий приоритет автоматически ([1](https://www.nvidia.com/en-gb/geforce/news/reflex-low-latency-platform)).
    
        - Это не NVIDIA Reflex, это LLM.
          
        - **Важно:** Ультра работает только для игр на DX9-DX11 (Не путать с DX11E), для DX12 обычно представлен Nvidia Reflex или он (Reflex) включен автоматически. Также стоит заметить, что не все игры/конфигурации стабильно работают с Ультра. Тестируйте, прежде чем ставить данный параметр на другое значение.
          
>[!IMPORTANT]
> Неверно суждение, что работа LLM схожа с Reflex, нет это не так. LLM работает на уровне драйвера и синхронизирует частоту кадров со скоростью рендера кадра (исходя из документации параметров FRL_LOW_LATENCY и LATENCY) и параллельно выставляет лимит кадров до рендеринга (то есть буфер пререндера, который почти никогда не будет достигать размера в размере больше 1 кадра, параметр PRERENDERLIMIT). Reflex работает на уровне движка игры, поэтому его использование в разы эффективнее.

>[!IMPORTANT]
> Важно заметить, что часть параметров, представленных в панели нвидиа, в документации имеют приписку OGL, что указывает на OpenGL. Поэтому для игр на DirectX нет никакой разницы при изменении данных настроек.

## Блокировка частот GPU/состояния 0 (P-State 0)

-  Принудительно включите P-State 0 с помощью [ключа реестра](https://github.com/djdallmann/GamingPCSetup/blob/master/CONTENT/RESEARCH/WINDRIVERS/README.md#q-is-there-a-registry-setting-that-can-force-your-display-adapter-to-remain-at-its-highest-performance-state-pstate-p0), приведенного ниже (требуется перезагрузка). Убедитесь, что ключ драйвера изменен на тот, который соответствует нужному графическому процессору NVIDIA ([пример](/docs/find-driver-key-example.png)). Это уменьшает нежелательную задержку выполнения новых инструкций, когда устройство переходит в состояние более глубокого энергосбережения, за счет более высоких температур простоя и энергопотребления.

    - На некоторых графических процессорах тактовая частота может с небольшим отрывом превышать установленную вами. Во избежание нестабильной работы убедитесь, что она настроена соответствующим образом.

``` bat
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Class\{4d36e968-e325-11ce-bfc1-08002be10318}\0000" /v "DisableDynamicPstate" /t REG_DWORD /d "1" /f
```

## Настройка NVIDIA Inspector

- Скачайте и распакуйте [NVIDIA Profile Inspector](https://github.com/Orbmu2k/nvidiaProfileInspector)

- Отключите ``Enable Ansel``, поскольку он внедряется во все игры драйверами дисплея, независимо от того, поддерживает ли игра Ansel или нет, что может вызвать конфликты со сторонними инструментами или инжекторами ([1](https://www.pcgamingwiki.com/wiki/Nvidia#Ansel)).

- Если применимо, вы можете поэкспериментировать с принудительной настройкой Resizable BAR в неподдерживаемых играх для потенциального повышения производительности, переключив следующие опции ([1](https://www.youtube.com/watch?v=ZTOtqWTFSK8))

  - rBAR - Feature

  - rBAR - Options

  - rBAR - Size Limit

- Отключите ``CUDA - Force P2 State``, чтобы предотвратить снижение тактовой частоты памяти во время рабочих нагрузок CUDA, когда она переходит в P-State 2 ([1](/docs/cuda-force-p2-state-analysis.png))

    - Также еще одна причина отключить данный пункт это предотвращение понижения частоты памяти во время стресс-тестирования.

## Удаление NvMessageBus.dll

- ```NvMessageBus.dll``` Вызывает большое количество циклов, поэтому его отключение положительно скажется на потреблении в фоне.

    - На некоторых конфигурациях может быть не активен.
